AWSTemplateFormatVersion: '2010-09-09'
Description: A CloudFormation template to deploy the Stable Diffusion Web UI by Automatic1111

Parameters:
  KeyName:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instance
    Type: AWS::EC2::KeyPair::KeyName
    ConstraintDescription: must be the name of an existing EC2 KeyPair.

Mappings:
  RegionToAmiId:
    ap-south-1:
      AMI: ami-0851b76e8b1bce90b
    eu-north-1:
      AMI: ami-0820d427f94ae9361
    eu-west-3:
      AMI: ami-023038f3ce67e7ac0
    eu-west-2:
      AMI: ami-065536dd9c2967f5c
    eu-west-1:
      AMI: ami-05147510eb2885c80
    ap-northeast-3:
      AMI: ami-0c7062e55d588c875
    ap-northeast-2:
      AMI: ami-022e92c3ed0cdee09
    ap-northeast-1:
      AMI: ami-07dc8296b13424b72
    ca-central-1:
      AMI: ami-0940df33750ae6e7f
    sa-east-1:
      AMI: ami-08fc9d46cd1bf888e
    ap-east-1:
      AMI: ami-0903d269fa9044c6b
    ap-southeast-1:
      AMI: ami-000892e0bc49a951d
    ap-southeast-2:
      AMI: ami-0f4b7f08ad2dc7197
    eu-central-1:
      AMI: ami-05210ba6bdf75db36
    us-east-1:
      AMI: ami-0a99b06fad09f48df
    us-east-2:
      AMI: ami-0a7a5669a8a7e55ae
    us-west-1:
      AMI: ami-0499d7290c9470715
    us-west-2:
      AMI: ami-09faf71ea24d57248

Resources:
  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub ${AWS::StackName}-sg
      GroupDescription: Security group for SD WebUI EC2 instance
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 7860
          ToPort: 7860
          CidrIp: 0.0.0.0/0
  EC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: c5.2xlarge
      ImageId: !FindInMap [RegionToAmiId, !Ref AWS::Region, AMI]
      KeyName: !Ref KeyName
      BlockDeviceMappings:
        - DeviceName: /dev/sda1
          Ebs:
            VolumeSize: 300
            VolumeType: gp2
      "Tags" : [
            {"Key" : "Name", "Value" : "sd-on-aws"},
        ]
      SecurityGroups:
        - Ref: SecurityGroup
      UserData:
        'Fn::Base64': |
            #!/bin/bash
            sudo sed -i "/#\$nrconf{restart} = 'i';/s/.*/\$nrconf{restart} = 'a';/" /etc/needrestart/needrestart.conf
            sudo apt-get update
            sudo apt install wget git python3 python3.8-venv build-essential net-tools libgl1 -y
            cd /home/ubuntu
            git clone https://github.com/AUTOMATIC1111/stable-diffusion-webui.git
            cd stable-diffusion-webui/extensions
            git clone https://github.com/awslabs/stable-diffusion-aws-extension.git
            cd stable-diffusion-aws-extension/
            ./pre-flight.sh -s
            cd ..
            sudo chown -R ubuntu:ubuntu stable-diffusion-aws-extension/ sd_dreambooth_extension/ sd-webui-controlnet/ ../../stable-diffusion-webui/
            cd ..
            sudo -u ubuntu python3 -m venv venv
            sudo -u ubuntu nohup bash webui.sh --enable-insecure-extension-access --skip-torch-cuda-test --no-half --listen > webui-log.txt

  MyEIP:
    Type: AWS::EC2::EIP
  MyEIPAssociation:
    Type: AWS::EC2::EIPAssociation
    Properties:
      AllocationId: !GetAtt MyEIP.AllocationId
      InstanceId: !Ref EC2Instance

Outputs:
  WebUIURL:
    Description: URL for Stable Diffusion Web UI
    # add port 7860 to the end of the URL
    Value: !Sub http://${MyEIP.PublicIp}:7860
